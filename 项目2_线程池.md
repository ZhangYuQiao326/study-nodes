# 基础

 ## 1 并发和并行

<img src="C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240310121105045.png" alt="image-20240310121105045" style="zoom:67%;" />

## 2 多线程种类

1. IO密集型程序：io操作比较多的程序，打开文件、设备、网络操作等
   * 单核：适合并发程序
   * 多核：适合并发程序
2. CPU密集型程序：计算操作比较多的程序，深度学习框架计算等
   * 单核：不适合并发，涉及到大量的上下文切换操作，即不断往寄存器保留和读取线程信息
   * 多核：适合并发

## 3 线程数量

<img src="C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240310122658588.png" alt="image-20240310122658588" style="zoom:67%;" />

* 一般线程数目等于cpu的内核数

## 4 线程同步

1. 线程互斥

   互斥锁mutex

   原子操作atomic

2. 线程通信

   条件变量

   * 生产者-消费者模型

     ```cpp
     // 生产
     int arr[]; // 资源
     condition_varable cond;
     mutex mtx;
     
     unique_lock<mutex> lock(mtx);
     while(arr.full()){
         cond.wait(lock); 
         // 生产
         cond.notify_all();
     }
     
     unique_lock<mutex> lock(mtx);
     while(arr.empty()){
         cond.wait(lock);
         // 消费
         cond.notify_all();
     }
     ```

   * wait做的事情

   * 1. 将进程状态由进行态改为等待
     2. 释放锁

# 项目细节

## 1 任务队列

task为临时对象，则声明周期到了后释放

为了延长task的声明周期，则通过智能指针控制，在run后释放task



## 2 线程池析构两种模式

###2.1 线程池关闭后不用执行剩余任务

* 线程函数内，以{线程池是否关闭}为条件进行循环
* 线程池关闭后，分别清除两类线程{阻塞态、刚执行完任务}

```cpp
while(!isRunning){
    while(task.size() == 0){
        wait(); // 任务队列为0，则阻塞
        if(!isRunning){erase()； return};  // 因为关闭唤醒，则析构退出
    }
    // 执行任务
    ...
}
// 执行完任务后，再次循环发现关闭，则删除退出
erase()； return
```



### 2.2 线程池关闭后继续执行完剩余任务后再析构

* 线程函数内，线程死循环执行
* 退出条件放在判断任务为0时

```cpp
for(;;){
    while(task.size() == 0){
        // 任务为空时，判断线程池是否关闭
        if(!isRunning){
            erase()； return
        }
        // 不关闭，则等待任务
        wait(); // 任务队列为0，则阻塞
        if(!isRunning){erase()； return};  // 因为关闭唤醒，则析构退出
    }
    // 执行任务
    ....
}
```

## 2.3 linux编译动态库

```shell
g++ -fPIC -shared threadPool.cpp -o libtdpool.so
// 移动文件
sudo mv libtdpool.so /usr/local/lib
sudo mv threadPool.h /usr/local/include/
g++ main.cpp -ltdpool

 vim /usr/include/c++/11/condition_variable
```

![image-20240318200625942](https://cdn.jsdelivr.net/gh/ZhangYuQiao326/study_nodes_pictures@main/img/image-20240318200625942.png)

![image-20240318200647587](https://cdn.jsdelivr.net/gh/ZhangYuQiao326/study_nodes_pictures@main/img/image-20240318200647587.png)